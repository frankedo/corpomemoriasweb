<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Publicaciones | Corpomemorias</title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        .card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .card-img-top {
            height: 250px;
            object-fit: cover;
            background: #f0f0f0;
        }
        .loader {
            width: 100%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #eee;
            color: #555;
            font-size: 18px;
        }
    </style>
</head>

<body>

<div class="container py-5">
    <h1 class="text-center mb-4">Publicaciones</h1>

    <div id="lista-publicaciones" class="row"></div>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

async function obtenerPortadaPDF(urlPDF) {
    try {
        const loadingTask = pdfjsLib.getDocument(urlPDF);
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);

        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: context, viewport }).promise;

        return canvas.toDataURL();
    } catch (err) {
        console.error("Error cargando portada:", err);
        return "https://placehold.co/300x400?text=Sin+Portada";
    }
}
</script>

<!-- Render Cards -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const contenedor = document.getElementById("lista-publicaciones");

    // *** CAMBIA ESTA URL POR TU BACKEND RENDER ***
    const backendURL = "https://supabase-backend-1-g0bt.onrender.com";

    try {
        const res = await fetch(`${backendURL}/publicaciones`);
        const publicaciones = await res.json();

        publicaciones.forEach(pub => {
            const col = document.createElement("div");
            col.className = "col-md-4 mb-4";

            col.innerHTML = `
                <div class="card">
                    <div class="loader">Cargando portada...</div>
                    <img class="card-img-top d-none portada-generada" data-pdf="${pub.url_pdf}" alt="Portada PDF">

                    <div class="card-body">
                        <h5 class="card-title">${pub.titulo}</h5>
                        <p class="card-text">${pub.descripcion || ""}</p>

                        <a href="${pub.url_pdf}" target="_blank" class="btn btn-primary btn-block">
                            Ver PDF
                        </a>
                    </div>
                </div>
            `;

            contenedor.appendChild(col);
        });

        // Luego cargamos portadas reales
        const imagenes = document.querySelectorAll(".portada-generada");

        imagenes.forEach(async img => {
            const urlPDF = img.dataset.pdf;
            const portada = await obtenerPortadaPDF(urlPDF);

            const loader = img.previousElementSibling;
            loader.classList.add("d-none");

            img.src = portada;
            img.classList.remove("d-none");
        });

    } catch (err) {
        console.error("Error cargando publicaciones:", err);
        contenedor.innerHTML =
            `<div class="col-12"><div class="alert alert-danger">Error cargando publicaciones.</div></div>`;
    }
});
</script>

<!-- Bootstrap scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

</body>
</html>
