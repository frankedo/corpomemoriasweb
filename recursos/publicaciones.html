<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sitio oficial de la Corporación Marlón Memorias y Huellas de un Desaparecido - Corpomemorias Aguachica. Luchamos por la dignidad de los desaparecidos en Colombia.">
    <meta name="author" content="Devcrud">

    <title>CORPOMEMORIAS | Publicaciones</title>

    <!-- CSS propio de tarjetas -->
    <link rel="stylesheet" href="../assets/css/card-general.css">

    <!-- Lightbox CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js" defer></script>

    <!-- Font Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
    /* Descripción limitada a 4 líneas */
    .card-text-general {
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar page-navbar navbar-light navbar-expand-md fixed-top">
    <div class="container">
        <a class="navbar-brand" href="../index.html">
            <strong class="text-primary">Corporación</strong> 
            <span class="text-dark">Marlón Memorias</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" 
                data-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</nav>

<!-- HEADER -->
<header id="home" class="header">
    <div class="overlay"></div>
    <div class="header-content" style="display: flex; flex-direction: column; align-items: center;">
        <p>Corporación Marlón Memorias y Huellas de un Desaparecido</p>
        <h6>Publicaciones</h6>

        <a href="https://wa.me/+573044868541?text=¡Hola!%20Quisiera%20más%20información"
           target="_blank" class="btn btn-outline-light" 
           style="display: flex; align-items: center; width: 250px; justify-content: center;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/WhatsApp_icon.png"
                 style="width: 20px; height: 20px; margin-right: 8px;">
           Conéctate con nosotros
        </a>
    </div>
</header>

<!-- Publicaciones -->
<section id="publicaciones_observatorio">
    <div class="container">
        <div class="about-wrapper">
            <div class="after"></div>
            <div class="content">

                <!-- FILTRO -->
                <div class="filtro-container" style="margin-bottom: 20px;">
                    <select id="filtroTipo">
                        <option value="">Filtrar por tipo</option>
                        <option value="informe">Informe</option>
                        <option value="boletin">Boletín</option>
                        <option value="revista">Revista</option>
                        <option value="libro">Libro</option>
                        <option value="taller">Taller</option>
                    </select>
                </div>

                <!-- GRID -->
                <div id="archivoGrid"></div>

            </div>
        </div>
    </div>
</section>

<!-- SCRIPT PDF.js -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

async function obtenerPortadaPDF(urlPDF) {
    try {
        const loadingTask = pdfjsLib.getDocument(urlPDF);
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);

        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: context, viewport }).promise;

        return canvas.toDataURL();
    } catch (err) {
        console.error("Error cargando portada:", err);
        return "https://placehold.co/300x400?text=Sin+Portada";
    }
}
</script>

<!-- SCRIPT PRINCIPAL -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const contenedor = document.getElementById("archivoGrid");
    const filtroTipo = document.getElementById("filtroTipo");
    const backendURL = "https://supabase-backend-1-g0bt.onrender.com";

    let publicaciones = [];

    try {
        const res = await fetch(`${backendURL}/publicaciones`);
        publicaciones = await res.json();

        renderizarTarjetas(publicaciones);

        filtroTipo.addEventListener("change", () => {
            const tipo = filtroTipo.value;
            const filtradas = publicaciones.filter(p => tipo ? p.tipo === tipo : true);
            renderizarTarjetas(filtradas);
        });

    } catch (err) {
        console.error("Error cargando publicaciones:", err);
        contenedor.innerHTML = `<div class="alert">Error cargando publicaciones.</div>`;
    }

    async function renderizarTarjetas(data) {
        contenedor.innerHTML = "";

        for (let pub of data) {
            const card = document.createElement("div");
            card.className = "card-general";

            card.innerHTML = `
                <div class="loader">Cargando portada...</div>
                <img class="portada-generada d-none" data-pdf="${pub.url_pdf}" alt="Portada PDF">
                <div class="card-body-general">
                    <h5 class="card-title-general">${pub.titulo}</h5>
                    <p><strong>Año:</strong> ${pub.fecha ? new Date(pub.fecha).getFullYear() : "Sin año"}</p>
                    <p class="card-text-general">${pub.descripcion || ""}</p>
                    <a href="${pub.url_pdf}" target="_blank" class="btn-general mb-2">Ver PDF</a>
                </div>
            `;
            contenedor.appendChild(card);
        }

        document.querySelectorAll(".portada-generada").forEach(async img => {
            const urlPDF = img.dataset.pdf;
            const portada = await obtenerPortadaPDF(urlPDF);
            img.previousElementSibling.classList.add("d-none");
            img.src = portada;
            img.classList.remove("d-none");
        });
    }
});
</script>

</body>
</html>
